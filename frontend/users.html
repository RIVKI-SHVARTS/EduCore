<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div id="navbar-container"></div>
    <script src="navbarAndName.js"></script>

    <h1>USERS</h1>

    <nav>
        <a href="users.html" class="active">All Users</a>
        <a href="addUser.html">Add User</a>
    </nav>

    <div id="allUsers"></div>

    <script src="alerts.js"></script>

    <script>

        const token = sessionStorage.getItem("token");

        async function getAllUsers() {
            try {
                const resp = await fetch("http://127.0.0.1:8000/users", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    }
                });

                if (!resp.ok) throw new Error(resp.status);

                return await resp.json();
            } catch (err) {
                console.error("Fetch failed:", err);
                showAlert("Unable to fetch users", "error");
                return null;
            }
        }

        const container = document.getElementById("allUsers");

        async function renderUsers() {
            const users = await getAllUsers();
            if (!users || !Array.isArray(users)) {
                container.innerHTML = "<p>No users to display</p>";
                return;
            }

            container.innerHTML = "";
            users.forEach(user => {
                const div = document.createElement("div");
                div.classList.add("user-card");

                const createdDate = user.createdDate
                    ? new Date(user.createdDate).toLocaleDateString()
                    : "N/A";
                const permissionsText = Array.isArray(user.permissions)
                    ? user.permissions.join(", ")
                    : "";

                div.innerHTML = `
                    <span class="label">Name:</span> <span class="value">${user.firstName} ${user.lastName}</span><br>
                    <span class="label">Username:</span> <span class="value">${user.username}</span><br>
                    <span class="label">Session Time Out:</span> <span class="value">${user.sessionTimeOut}</span><br>
                    <span class="label">Created Date:</span> <span class="value">${createdDate}</span><br>
                    <span class="label">Permissions:</span> <span class="value">${permissionsText}</span><br>
                    <button onclick="editUser('${user._id}')">EDIT</button>
                    <button onclick="deleteUser('${user._id}')">DELETE</button>
                `;
                container.appendChild(div);
            });
        }

        function editUser(userId) {
            sessionStorage.setItem("userIdToEdit", userId);
            window.location.href = "editUser.html";
        }

        function deleteUser(id) {
            showAlert(
                "Are you sure you want to delete this user?",
                "confirm",
                0,
                async () => {
                    try {
                        const resp = await fetch(`http://127.0.0.1:8000/users/${id}`, {
                            method: "DELETE",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${token}`
                            }
                        });

                        if (!resp.ok) throw new Error(resp.status);

                        await resp.json();
                        showAlert("User deleted", "success");
                        setTimeout(() => {
                            renderUsers();
                        },3000);

                    } catch (err) {
                        console.error("Error deleting user:", err);
                        showAlert("Error deleting user", "error");
                    }
                },
            );
        }

        renderUsers();
    </script>

    <script src="auth.js"></script>
</body>

</html>