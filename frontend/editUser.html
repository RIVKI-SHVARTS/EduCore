<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>edit user</title>
  <link rel="stylesheet" href="style.css">

</head>

<body>


  <div id="navbar-container"></div>
  <script src="navbarAndName.js"></script>

  <script src="alerts.js"></script>

  <h1 id="editUserTitle">edit user:</h1>
  <div id="divContainer"></div>

  <script>
    const userId = sessionStorage.getItem("userIdToEdit");
    const token = sessionStorage.getItem("token");
    let currentUser = ""


    const gtUserData = async () => {
      try {
        const resp = await fetch(`http://127.0.0.1:8000/users/${userId}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          }
        });

        if (!resp.ok) {
          throw new Error(`HTTP error! Status: ${resp.status}`);
        }

        
        const user = await resp.json();
        currentUser = user
        return user;
      } catch (err) {
        console.error("Error fetching user:", err);
      }
    };

    const setUserData = async () => {
      const user = await gtUserData();
      console.log(user);
      const title = document.getElementById("editUserTitle");
      title.innerText = `edit: ${user.firstName} ${user.lastName}`;

      const container = document.getElementById("divContainer");
      container.innerHTML = `
      <div class="form-card">
        <label for="firstName">first name:</label>
                <input type="text" value="${user.firstName}" onchange="handleInputChange(this,'firstName')"><br><br> 
                <label for="lastName">last name:</label>
                <input type="text" value="${user.lastName}" onchange="handleInputChange(this,'lastName')"><br><br> 
                <label for="userName">user name:</label>
                <input type="text" value="${user.username}" onchange="handleInputChange(this,'username')"><br><br> 
                <label for="time">session time out:</label>
                <input type="number" value="${user.sessionTimeOut}" onchange="handleInputChange(this,'sessionTimeOut')"><br><br> 
                created date: ${user.createdDate}  <br><br>    
                <label>Permissions:</label>
                <div id="permissionsContainer"></div>

                <div class="button-group">
                <button id = "updateBtn">Update</button>
                <button onclick="cancel()">Cancel</button>
              </div>
    </div>

            `;
      document.getElementById("updateBtn").addEventListener("click", () => update(user._id));
      const allPermissions = [
        "View Enrollments",
        "Create Enrollments",
        "Delete Enrollments",
        "Update Enrollments",
        "View Courses",
        "Create Courses",
        "Delete Courses",
        "Update Courses"
      ];

      const permissionsContainer = document.getElementById("permissionsContainer");

      allPermissions.forEach((perm, index) => {
        const checkboxId = `perm_${index}`;
        const isChecked = user.permissions.includes(perm); // בדיקה אם למשתמש יש את ההרשאה הזאת

        const div = document.createElement("div");
        div.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" name="permissions" value="${perm}" ${isChecked ? "checked" : ""} onchange="handlePermissionChange(this, this.value)">
                    <label for="${checkboxId}">${perm}</label>
                `;

        permissionsContainer.appendChild(div);
      });
    };

    const handleInputChange = (element, key) => {
      // const newValue = element.value;
      // currentUser = { ...currentUser, [key]: newValue };
      let newValue = element.value;
      // אם מדובר בשדה sessionTimeOut – נמיר למספר
      if (key === 'sessionTimeOut') {
        newValue = Number(newValue); // או parseInt(newValue)
      }
      currentUser = { ...currentUser, [key]: newValue };

      console.log("Updated user data:", currentUser);
    };


    const handlePermissionChange = (element, key) => {
      const isChecked = element.checked;
      const permissionsArr = currentUser.permissions;

      if (isChecked) {
        // הוספת צפייה אם מסמנים פעולת ניהול
        if (
          ["Create Enrollments", "Delete Enrollments", "Update Enrollments"].includes(key) &&
          !permissionsArr.includes("View Enrollments")
        ) {
          permissionsArr.push("View Enrollments");
          document.querySelector('input[value="View Enrollments"]').checked = true;
        }

        if (
          ["Create Courses", "Delete Courses", "Update Courses"].includes(key) &&
          !permissionsArr.includes("View Courses")
        ) {
          permissionsArr.push("View Courses");
          document.querySelector('input[value="View Courses"]').checked = true;
        }

        if (!permissionsArr.includes(key)) {
          permissionsArr.push(key);
        }
      } else {
        // הסרה של ההרשאה שנלחצה
        currentUser.permissions = permissionsArr.filter(p => p !== key);

        // הסרה של צפייה אם לא נותרו פעולות שדורשות אותה
        if (
          ["Create Enrollments", "Delete Enrollments", "Update Enrollments"].includes(key) &&
          !currentUser.permissions.some(p =>
            ["Create Enrollments", "Delete Enrollments", "Update Enrollments"].includes(p)
          )
        ) {
          currentUser.permissions = currentUser.permissions.filter(p => p !== "View Enrollments");
          document.querySelector('input[value="View Enrollments"]').checked = false;
        }

        if (
          ["Create Courses", "Delete Courses", "Update Courses"].includes(key) &&
          !currentUser.permissions.some(p =>
            ["Create Courses", "Delete Courses", "Update Courses"].includes(p)
          )
        ) {
          currentUser.permissions = currentUser.permissions.filter(p => p !== "View Courses");
          document.querySelector('input[value="View Courses"]').checked = false;
        }
      }

      console.log("Updated permissions:", currentUser.permissions);
    };



    const update = async (id) => {
      
      const resp = await fetch(`http://127.0.0.1:8000/users/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(currentUser),
      })


      const data = await resp.json()
     
      if (currentUser._id === sessionStorage.getItem("userId")) {
        sessionStorage.setItem("permissions", JSON.stringify(currentUser.permissions));
      }
      
      console.log("Before alert");
      showAlert("Updated successfully!", "success");
      console.log("After alert");

      setTimeout(() => {
        window.location.href = "manageUsers.html";
      }, 3500);
    }


    const cancel = () => {
      window.location.href = "manageUsers.html";
    }

    setUserData();
  </script>
  <script src="auth.js"></script>
</body>

</html>